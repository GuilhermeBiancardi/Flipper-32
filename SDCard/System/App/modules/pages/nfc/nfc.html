<div class="card card-fixed">
    <div class="card-body">
        <div class="btn-toolbar" role="toolbar">
            <div class="d-flex align-items-center">
                <i id="nfc_on_off" class="bi bi-circle-fill fs-6px text-danger me-2"></i>
            </div>
            <div class="btn-group me-2" role="group">
                <button type="button" id="nfc_menu_read" class="btn btn-outline-secondary">
                    <i class="bi bi-toggle-on"></i>
                </button>
                <button type="button" id="nfc_menu_sd_card" class="btn btn-outline-secondary">
                    <i class="bi bi-sd-card"></i>
                </button>
                <button type="button" id="nfc_menu_log" class="btn btn-outline-secondary">
                    <i class="bi bi-file-earmark-text"></i>
                </button>
                <button type="button" id="nfc_menu_tag" class="btn btn-outline-secondary">
                    <i class="bi bi-gear"></i>
                </button>
                <button type="button" id="nfc_menu_info" class="btn btn-outline-secondary">
                    <i class="bi bi-info-circle"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="mt-5"></div>

<div id="block-log" class="animated-05 fadeInLeft d-none mb-3">

    <div class="card">
        <div class="card-header fw-bold small text-uppercase">
            Log de Gravação Multipla:
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="nfc_table_log" class="table table-striped table-borderless mb-2px small text-nowrap">
                    <tbody>
                        
                    </tbody>
                </table>
            </div>

        </div>
        <div class="card-arrow">
            <div class="card-arrow-top-left"></div>
            <div class="card-arrow-top-right"></div>
            <div class="card-arrow-bottom-left"></div>
            <div class="card-arrow-bottom-right"></div>
        </div>
    </div>

</div>

<div id="block-legend" class="animated-05 fadeInLeft d-none mb-3">

    <div class="card">
        <div class="card-header fw-bold small text-uppercase">
            Informativo / Legendas
        </div>
        <div class="card-body">

            <div class="table-responsive">
                <table class="table small text-nowrap m-0">
                    <thead>
                        <tr style='background: var(--bs-table-striped-bg);'>
                            <th scope="col" style="width: 50px;">Símbolo</th>
                            <th scope="col" class="w-100">Função</th>
                        </tr>
                    </thead>
                    <tbody id="legend_data">
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-toggle-on me-2"></i>
                                </a>
                            </td>
                            <td>
                                Liga o modo leitura do NFC, este modo permite ler o conteúdo de Tags.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-credit-card-2-front me-2"></i>
                                </a>
                            </td>
                            <td>
                                Abre os dados completos da Tag em JSON.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-sd-card me-2"></i>
                                </a>
                            </td>
                            <td>
                                Abre as opções de armazenamento externo.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                </a>
                            </td>
                            <td>
                                Log de Gravação Multipla.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-pen me-2"></i>
                                </a>
                            </td>
                            <td>
                                Grava o conteúdo do bloco na Tag.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-trash2 me-2"></i>
                                </a>
                            </td>
                            <td>
                                Apaga todo o conteúdo do bloco.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-slash-circle me-2"></i>
                                </a>
                            </td>
                            <td>
                                Nenhuma ação disponível.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-folder-plus me-2"></i>
                                </a>
                            </td>
                            <td>
                                Seleciona a pasta atual, isso possibilita a criação de arquivos e pastas dentro da mesma.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-folder-minus me-2"></i>
                                </a>
                            </td>
                            <td>
                                Deseleciona a pasta atual, voltando para a pasta anterior.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-trash2 me-2"></i>
                                </a>
                            </td>
                            <td>
                                Deleta um arquivo ou diretório.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-download me-2"></i>
                                </a>
                            </td>
                            <td>
                                Abre o arquivo e pega seu conteúdo.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-folder me-2"></i>
                                </a>
                            </td>
                            <td>
                                Pasta fechada.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-folder2-open me-2"></i>
                                </a>
                            </td>
                            <td>
                                Pasta aberta.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-folder-x me-2"></i>
                                </a>
                            </td>
                            <td>
                                Pasta vazia.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-circle-fill text-danger me-2"></i>
                                </a>
                            </td>
                            <td>
                                O modo leitura não está ativo.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-circle-fill text-success me-2"></i>
                                </a>
                            </td>
                            <td>
                                Modo Leitura está ativo.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-square-fill text-danger me-2"></i>
                                </a>
                            </td>
                            <td>
                                Bloco reservado para armazenar a chave de acesso do setor.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-square-fill text-warning me-2"></i>
                                </a>
                            </td>
                            <td>
                                Bloco reservado para armazenar dados do fabricante.
                            </td>
                        </tr>
                        <tr>
                            <td class="text-center">
                                <a>
                                    <i class="bi bi-square-fill text-success me-2"></i>
                                </a>
                            </td>
                            <td>
                                Bloco disponível para gravação (Max: 16 caracteres).
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
        <div class="card-arrow">
            <div class="card-arrow-top-left"></div>
            <div class="card-arrow-top-right"></div>
            <div class="card-arrow-bottom-left"></div>
            <div class="card-arrow-bottom-right"></div>
        </div>
    </div>

</div>

<div id="block-sd-card" class="animated-05 fadeInLeft d-none mb-3">

    <div class="card">
        <div class="card-header fw-bold small text-uppercase">
            Carregar/Salvar TAGs do/no cartão SD
        </div>
        <div class="card-body">
            <div class="input-group">
                <span class="input-group-text" id="path-nfc">NFC/</span>
                <input id="path-nfc-input" type="text" class="form-control" placeholder="Nome do Arquivo">
                <button class="btn btn-outline-secondary" type="button" id="create-file">Criar Arquivo</button>
                <button class="btn btn-outline-secondary" type="button" id="create-folder">Criar Pasta</button>
                <button class="btn btn-outline-secondary" type="button" id="list-files-sd">Listar Arquivos</button>
            </div>
            <br>
            <div id="nfc_files_tree" class="treeview"></div>
        </div>
        <div class="card-arrow">
            <div class="card-arrow-top-left"></div>
            <div class="card-arrow-top-right"></div>
            <div class="card-arrow-bottom-left"></div>
            <div class="card-arrow-bottom-right"></div>
        </div>
    </div>

</div>

<div id="block-tag" class="animated-05 fadeInLeft d-none mb-3">

    <div class="card">
        <div class="card-header fw-bold small text-uppercase">
            Dados completos da TAG
        </div>
        <div class="card-body">

            <div class="input-group flex-nowrap">
                <span class="input-group-text">UID</span>
                <input id="card_uid" class="form-control form-control text-uppercase" type="text" placeholder="00000000" readonly>
            </div>

            <br>
            <label class="form-label" for="json-nfc">JSON Tag</label>
            <textarea class="form-control" id="json-nfc" rows="8" disabled></textarea>
            <br>
            <buttom id="nfc_tag_save" class="btn btn-default form-control">Gravar JSON na Tag.</buttom>

        </div>
        <div class="card-arrow">
            <div class="card-arrow-top-left"></div>
            <div class="card-arrow-top-right"></div>
            <div class="card-arrow-bottom-left"></div>
            <div class="card-arrow-bottom-right"></div>
        </div>
    </div>

</div>

<script>

    var json_empy = '{"type":"NFC_TAG_4K","uid":"","sector_0":{"key_a":"","key_b":"","block_0":{"data":""},"block_1":{"data":""},"block_2":{"data":""},"block_3":{"data":""}},"sector_1":{"key_a":"","key_b":"","block_4":{"data":""},"block_5":{"data":""},"block_6":{"data":""},"block_7":{"data":""}},"sector_2":{"key_a":"","key_b":"","block_8":{"data":""},"block_9":{"data":""},"block_10":{"data":""},"block_11":{"data":""}},"sector_3":{"key_a":"","key_b":"","block_12":{"data":""},"block_13":{"data":""},"block_14":{"data":""},"block_15":{"data":""}},"sector_4":{"key_a":"","key_b":"","block_16":{"data":""},"block_17":{"data":""},"block_18":{"data":""},"block_19":{"data":""}},"sector_5":{"key_a":"","key_b":"","block_20":{"data":""},"block_21":{"data":""},"block_22":{"data":""},"block_23":{"data":""}},"sector_6":{"key_a":"","key_b":"","block_24":{"data":""},"block_25":{"data":""},"block_26":{"data":""},"block_27":{"data":""}},"sector_7":{"key_a":"","key_b":"","block_28":{"data":""},"block_29":{"data":""},"block_30":{"data":""},"block_31":{"data":""}},"sector_8":{"key_a":"","key_b":"","block_32":{"data":""},"block_33":{"data":""},"block_34":{"data":""},"block_35":{"data":""}},"sector_9":{"key_a":"","key_b":"","block_36":{"data":""},"block_37":{"data":""},"block_38":{"data":""},"block_39":{"data":""}},"sector_10":{"key_a":"","key_b":"","block_40":{"data":""},"block_41":{"data":""},"block_42":{"data":""},"block_43":{"data":""}},"sector_11":{"key_a":"","key_b":"","block_44":{"data":""},"block_45":{"data":""},"block_46":{"data":""},"block_47":{"data":""}},"sector_12":{"key_a":"","key_b":"","block_48":{"data":""},"block_49":{"data":""},"block_50":{"data":""},"block_51":{"data":""}},"sector_13":{"key_a":"","key_b":"","block_52":{"data":""},"block_53":{"data":""},"block_54":{"data":""},"block_55":{"data":""}},"sector_14":{"key_a":"","key_b":"","block_56":{"data":""},"block_57":{"data":""},"block_58":{"data":""},"block_59":{"data":""}},"sector_15":{"key_a":"","key_b":"","block_60":{"data":""},"block_61":{"data":""},"block_62":{"data":""},"block_63":{"data":""}}}';
    var json_mdfy = json_empy;
    var tag_size = "16";

    function EmpyTableCardData() {

        var table_start = '\
        <div class="col-12 col-lg-6 mb-3">\
            <div id="nfc_card-[ID_SECTOR]" class="card">\
                <div class="card-header fw-bold text-uppercase">\
                    Setor [ID_SECTOR]\
                    <div class="d-flex flex-row">\
                        <a id="nfc_key_menu-[ID_SECTOR]" class="float-end fs-6 bi-key p-1 m-1 text-inverse" role="button" data-bs-toggle="collapse" data-bs-target="#nfc_key_panel-[ID_SECTOR]" aria-expanded="true">\</a>\
                        <a id="nfc_burn_menu-[ID_SECTOR]" class="float-end fs-6 bi-fire p-1 m-1 text-inverse" role="button" data-bs-toggle="collapse" data-bs-target="#nfc_burn_panel-[ID_SECTOR]" aria-expanded="true"></a>\
                    </div>\
                </div>\
                <div class="card-body">\
                    <div id="card_sector-[ID_SECTOR]">\
                        <div class="table-responsive">\
                            <table class="table mb-2px small text-nowrap m-0">\
                                <thead>\
                                    <tr style="background: var(--bs-table-striped-bg);">\
                                        <th scope="col">Bloco</th>\
                                        <th scope="col" class="w-100">Dados</th>\
                                        <th scope="col">Ações</th>\
                                    </tr>\
                                </thead>\
                                <tbody id="card_table_data_[ID_SECTOR]">\
        ';

        var table_data = '\
        <tr>\
            <td class="text-center">[BLOCKS]</td>\
            <td>\
                <span class="d-flex align-items-center">\
                    [DOT]\
                    <input type="text" id="block_data-[ID_BLOCK]" class="block_data form-control border-0 p-0" maxlength="16" value="[DATA]" />\
                </span>\
            </td>\
            <td class="text-center">\
                [ACTIONS]\
            </td>\
        </tr>';

        var table_data_action_delete = '\
        <a id="block_data_delete-[ID_BLOCK]" class="text-decoration-none text-inverse block_data_delete">\
            <i class="bi bi-trash2 me-2"></i>\
        </a>\
        ';

        var table_data_action_write = '\
        <a id="block_data_write-[ID_BLOCK]" class="text-decoration-none text-inverse block_data_write">\
            <i class="bi bi-pen me-2"></i>\
        </a>\
        ';

        var table_data_action_nothing = '\
        <a class="text-decoration-none text-inverse">\
            <i class="bi bi-slash-circle me-2"></i>\
        </a>\
        <a class="text-decoration-none text-inverse">\
            <i class="bi bi-slash-circle me-2"></i>\
        </a>\
        ';

        var table_end = '\
                                    </tbody>\
                                </table>\
                            </div>\
                            <div id="nfc_burn_panel-[ID_SECTOR]" class="accordion-collapse collapse mt-3">\
                                <div class="input-group flex-nowrap">\
                                    <span class="input-group-text">USAR CHAVE:</span>\
                                    <select id="nfc_type_key_sector-[ID_SECTOR]" class="form-select" style="min-width: 110px;">\
                                        <option value="0">A</option>\
                                        <option value="1">B</option>\
                                    </select>\
                                    <buttom id="nfc_sector_save-[ID_SECTOR]" class="btn btn-default form-control save_sector">Gravar Setor</buttom>\
                                </div>\
                            </div>\
                            <div id="nfc_key_panel-[ID_SECTOR]" class="accordion-collapse collapse">\
                                <div class="card mb-3 mt-3">\
                                    <div class="card-header fw-bold small text-uppercase">\
                                        Chave Atual\
                                    </div>\
                                    <div class="card-body">\
                                        <div class="input-group flex-nowrap">\
                                            <span class="input-group-text">CHAVE A</span>\
                                            <span class="input-group-text">STR</span>\
                                            <input type="text" id="nfc_str_key_a_sector-[ID_SECTOR]" class="form-control w-100 key_sector" maxlength="6" placeholder="XXXXXX" style="min-width: 75px;">\
                                            <span class="input-group-text">HEX</span>\
                                            <input type="text" id="nfc_hex_key_a_sector-[ID_SECTOR]" class="form-control w-100 text-uppercase key_sector" maxlength="12" placeholder="XXXXXXXXXXXX" style="min-width: 120px;">\
                                        </div>\
                                        <div class="p-1"></div>\
                                        <div class="input-group flex-nowrap">\
                                            <span class="input-group-text">KEY ACS</span>\
                                            <span class="input-group-text">STR</span>\
                                            <input type="text" id="nfc_str_key_acs_sector-[ID_SECTOR]" class="form-control w-100 key_sector" maxlength="4" placeholder="XXXX" style="min-width: 75px;">\
                                            <span class="input-group-text">HEX</span>\
                                            <input type="text" id="nfc_hex_key_acs_sector-[ID_SECTOR]" class="form-control w-100 text-uppercase key_sector" maxlength="8" placeholder="XXXXXXXX" style="min-width: 120px;">\
                                        </div>\
                                        <div class="p-1"></div>\
                                        <div class="input-group flex-nowrap">\
                                            <span class="input-group-text">CHAVE B</span>\
                                            <span class="input-group-text">STR</span>\
                                            <input type="text" id="nfc_str_key_b_sector-[ID_SECTOR]" class="form-control w-100 key_sector" maxlength="6" placeholder="XXXXXX" style="min-width: 75px;">\
                                            <span class="input-group-text">HEX</span>\
                                            <input type="text" id="nfc_hex_key_b_sector-[ID_SECTOR]" class="form-control w-100 text-uppercase key_sector" maxlength="12" placeholder="XXXXXXXXXXXX" style="min-width: 120px;">\
                                        </div>\
                                    </div>\
                                    <div class="card-arrow">\
                                        <div class="card-arrow-top-left"></div>\
                                        <div class="card-arrow-top-right"></div>\
                                        <div class="card-arrow-bottom-left"></div>\
                                        <div class="card-arrow-bottom-right"></div>\
                                    </div>\
                                </div>\
                                <div class="card">\
                                    <div class="card-header fw-bold small text-uppercase">\
                                        Nova Chave\
                                    </div>\
                                    <div class="card-body">\
                                        <div class="input-group flex-nowrap">\
                                            <span class="input-group-text">CHAVE A</span>\
                                            <span class="input-group-text">STR</span>\
                                            <input type="text" id="nfc_new_str_key_a_sector-[ID_SECTOR]" class="form-control w-100 key_sector" maxlength="6" placeholder="XXXXXX" style="min-width: 75px;">\
                                            <span class="input-group-text">HEX</span>\
                                            <input type="text" id="nfc_new_hex_key_a_sector-[ID_SECTOR]" class="form-control w-100 text-uppercase key_sector" maxlength="12" placeholder="XXXXXXXXXXXX" style="min-width: 120px;">\
                                        </div>\
                                        <div class="p-1"></div>\
                                        <div class="input-group flex-nowrap">\
                                            <span class="input-group-text">KEY ACS</span>\
                                            <span class="input-group-text">STR</span>\
                                            <input type="text" id="nfc_new_str_key_acs_sector-[ID_SECTOR]" class="form-control w-100 key_sector" maxlength="4" placeholder="XXXX" style="min-width: 75px;">\
                                            <span class="input-group-text">HEX</span>\
                                            <input type="text" id="nfc_new_hex_key_acs_sector-[ID_SECTOR]" class="form-control w-100 text-uppercase key_sector" maxlength="8" placeholder="XXXXXXXX" style="min-width: 120px;">\
                                        </div>\
                                        <div class="p-1"></div>\
                                        <div class="input-group flex-nowrap">\
                                            <span class="input-group-text">CHAVE B</span>\
                                            <span class="input-group-text">STR</span>\
                                            <input type="text" id="nfc_new_str_key_b_sector-[ID_SECTOR]" class="form-control w-100 key_sector" maxlength="6" placeholder="XXXXXX" style="min-width: 75px;">\
                                            <span class="input-group-text">HEX</span>\
                                            <input type="text" id="nfc_new_hex_key_b_sector-[ID_SECTOR]" class="form-control w-100 text-uppercase key_sector" maxlength="12" placeholder="XXXXXXXXXXXX" style="min-width: 120px;">\
                                        </div>\
                                        <div class="p-1"></div>\
                                        <buttom id="nfc_key_save-[ID_SECTOR]" class="btn btn-default form-control save_sector_keys">Gravar Chaves</buttom>\
                                    </div>\
                                    <div class="card-arrow">\
                                        <div class="card-arrow-top-left"></div>\
                                        <div class="card-arrow-top-right"></div>\
                                        <div class="card-arrow-bottom-left"></div>\
                                        <div class="card-arrow-bottom-right"></div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                </div>\
                <div class="card-arrow">\
                    <div class="card-arrow-top-left"></div>\
                    <div class="card-arrow-top-right"></div>\
                    <div class="card-arrow-bottom-left"></div>\
                    <div class="card-arrow-bottom-right"></div>\
                </div>\
            </div>\
        </div>\
        ';

        var dot = "<i class='bi bi-square-fill fs-6px text-[COLOR] me-2'></i>";

        var key_blocks = [0, 3, 7, 11, 15, 19, 23, 27, 31, 35, 39, 43, 47, 51, 55, 59, 63];

        var blocks = 0;

        for (var i = 0; i < tag_size; i++) {

            var table = table_start;

            for (var j = 0; j < 4; j++) {

                var replace_table_data = "";
                var replace_dot = "";
                var block = ((i * 4) + j);

                if (i == 0 && j == 0) {
                    replace_dot = dot.replace(/\[COLOR\]/, "warning");
                    replace_table_data = table_data.replace(/\[DOT\]/, replace_dot);
                    replace_table_data = replace_table_data.replace(/\[DATA\]/, "Dados do Fabricante");
                    replace_table_data = replace_table_data.replace(/\[ACTIONS\]/, table_data_action_nothing);
                } else {
                    if (key_blocks.find(element => element == blocks)) {
                        replace_dot = dot.replace(/\[COLOR\]/, "danger");
                        replace_table_data = table_data.replace(/\[DOT\]/, replace_dot);
                        // replace_table_data = replace_table_data.replace(/\[EDITABLE\]/, "");
                        replace_table_data = replace_table_data.replace(/\[DATA\]/, "Chave do Setor");
                        replace_table_data = replace_table_data.replace(/\[ACTIONS\]/, table_data_action_nothing);
                    } else {
                        replace_dot = dot.replace(/\[COLOR\]/, "success");
                        replace_table_data = table_data.replace(/\[DOT\]/, replace_dot);
                        // replace_table_data = replace_table_data.replace(/\[EDITABLE\]/, "contenteditable");
                        replace_table_data = replace_table_data.replace(/\[DATA\]/, "Vazio");
                        replace_table_data = replace_table_data.replace(/\[ACTIONS\]/, table_data_action_write + table_data_action_delete);
                    }
                }

                replace_table_data = replace_table_data.replaceAll(/\[ID_BLOCK\]/g, i + "_" + block);
                replace_table_data = replace_table_data.replace(/\[BLOCKS\]/, blocks);
                table += replace_table_data;
                blocks++;

            }

            table += table_end;
            table = table.replaceAll(/\[ID_SECTOR\]/g, i);

            $("#modules").append(table);

        }

        SectorEvents();
    }

    function AnimateMenu(obj, conteudo, aIn = "fadeInLeft", aOut = "fadeOutLeft") {
        if (obj.hasClass("btn-secondary")) {
            obj.removeClass("btn-secondary").addClass("btn-outline-secondary");
            $("#" + conteudo).removeClass(aIn).addClass(aOut);
            window.setTimeout(() => {
                $("#" + conteudo).toggleClass("d-none");
            }, 500);
        } else {
            obj.removeClass("btn-outline-secondary").addClass("btn-secondary");
            $("#" + conteudo).removeClass(aOut).addClass(aIn);
            $("#" + conteudo).toggleClass("d-none");
        }
    }

    function SectorEvents() {

        $(".block_data").keyup(function(event) {
            var text = $(this).val();
            var id = $(this).attr("id").split("-");
            var sb = id[1].split("_");
            var auxJson = JSON.parse(json_mdfy);
            auxJson["sector_" + sb[0]]["block_" + sb[1]]["data"] = StringToHex(text);
            json_mdfy = JSON.stringify(auxJson);
            $("#json-nfc").val(json_mdfy);
        });

        $(".block_data").on('focus', function() {
            if ($(this).val() === 'Vazio') {
                $(this).val('');
            }
        });

        $(".block_data").on('blur', function() {
            if ($(this).val() === '') {
                $(this).val('Vazio');
            }
        });

        $(".block_data_write").unbind();
        $(".block_data_write").click(function () {

            var id = $(this).attr("id").split("-");
            var sector_block = id[1].split("_");
            var sector = sector_block[0];
            var block = sector_block[1];
            var type = $("#nfc_type_key_sector-" + sector).val();
            var key = $("#nfc_hex_key_a_sector-" + sector).val();
            if(type == 1) {
                key = $("#nfc_hex_key_b_sector-" + sector).val();
            }
            var dados = $("#block_data-" + id[1]).val();

            if (dados == "Vazio") {
                dados = "";
            }

            if (dados.length <= 16) {
                if (key != "") {

                    var data = {
                        "block": block,
                        "type": type,
                        "key": key,
                        "data": StringToHex(dados)
                    };

                    request("/NFC_WRITE_ON", data, function (response) {
                        if (isJson(response)) {
                            var json = JSON.parse(response);
                            notify(json.status, json.message);
                            ONOFF("off");
                        }
                    }, function (response) {
                        notify("error", "Houve um problema com a comunicação.");
                    });

                } else {
                    notify("warning", "A chave de acesso do setor não foi informada.");
                }
            } else {
                notify("warning", "O dado a ser gravado não pode exceder 16 caracteres.");
            }

        });

        $(".block_data_delete").unbind();
        $(".block_data_delete").click(function () {
            var id = $(this).attr("id").split("-");
            var sb = id[1].split("_");
            var auxJson = JSON.parse(json_mdfy);
            auxJson["sector_" + sb[0]]["block_" + sb[1]]["data"] = "";
            json_mdfy = JSON.stringify(auxJson);
            $("#json-nfc").val(json_mdfy);
            $("#block_data-" + id[1]).val("Vazio");
        });

        $(".key_sector").unbind();
        $(".key_sector").keyup(function () {
            var id = $(this).attr("id").split("-");
            var value = $(this).val();
            var auxJson = JSON.parse(json_mdfy);
            if (id[0] == "nfc_new_str_key_a_sector" || id[0] == "nfc_new_str_key_b_sector") {
                var hex = StringToHex(value);
                $("#" + id[0].replaceAll(/\_str\_/g, "_hex_") + "-" + id[1]).val(hex);
                if(id[0].indexOf("a") != -1) {
                    auxJson["sector_" + id[1]]["key_a"] = hex;
                } else {
                    auxJson["sector_" + id[1]]["key_b"] = hex;
                }
            } else {
                if(id[0].indexOf("a") != -1) {
                    auxJson["sector_" + id[1]]["key_a"] = value;
                } else {
                    auxJson["sector_" + id[1]]["key_b"] = value;
                }
                if (value.length % 2 == 1) {
                    value = value.slice(0, (value.length - 1));
                }
                var str = HexToString(value);
                $("#" + id[0].replaceAll(/\_hex\_/g, "_str_") + "-" + id[1]).val(str);
            }
            json_mdfy = JSON.stringify(auxJson);
            $("#json-nfc").val(json_mdfy);
        });

        $(".save_sector").unbind();
        $(".save_sector").click(function() {
            var id = $(this).attr("id").split("-");
            asyncSectorSave(id).then(() => {
                notify("success", "Comando concluído, consulte o log de gravação para obter mais detalhes.");
                ONOFF("off");
            }).catch((error) => {
                notify("error", "Ocorreu um erro durante o processamento: " + error);
            });
        });

        $(".save_sector_keys").unbind();
        $(".save_sector_keys").click(function() {
            var id = $(this).attr("id").split("-");
            var block = ((parseInt(id[1]) * 4) + 3);
            var new_key_a = $("#nfc_new_hex_key_a_sector-" + id[1]).val();
            var key_acs = $("#nfc_new_hex_key_acs_sector-" + id[1]).val();
            var new_key_b = $("#nfc_new_hex_key_b_sector-" + id[1]).val();
            if(new_key_a != "" && new_key_b != "") {
                if(new_key_a.length == 12 && new_key_b.length == 12) {
                    if(isHex(new_key_a) && isHex(new_key_b)) {
                        if(key_acs == $("#nfc_hex_key_acs_sector-" + id[1]).val()) {
                            logTableAdd("reset");
                            var data = {
                                "block": block,
                                "key_a": $("#nfc_hex_key_a_sector-" + id[1]).val(),
                                "key_b": $("#nfc_hex_key_b_sector-" + id[1]).val(),
                                "new_key": new_key_a + key_acs + new_key_b,
                            };
                            request("/NFC_WRITE_KEY_ON", data, function (response) {
                                if (isJson(response)) {
                                    var json = JSON.parse(response);
                                    json.status == "success" ? json.menssage = "KeyA e KeyB foram alteradas com sucesso!" : json.menssage;
                                    notify(json.status, json.menssage);
                                    ONOFF("off");
                                }
                            }, function (response) {
                                notify("warning", "Houve um problema com a comunicação.");
                            });
                        } else {
                            notify("warning", "A KEY ACS está diferente do padrão do cartão, se continuar os dados do setor poderão ser perdidos.");
                        }
                    } else {
                        notify("warning", "Chave A ou Chave B não são um HEX válido.");
                    }
                } else {
                    notify("warning", "Chave A ou Chave B não contém 6 caracteres STR ou 12 caracteres HEX.");
                }
            } else {
                notify("warning", "Chave A e Chave B são necessárias para gravação, certifique-se que ambas foram informadas.");
            }
        });

    }

    async function asyncSectorSave(id) {
        logTableAdd("reset");
        var start = (parseInt(id[1]) * 4);
        var type = $("#nfc_type_key_sector-" + id[1]).val();
        var key = $("#nfc_hex_key_a_sector-" + id[1]).val();
        type == 1 ? key = $("#nfc_hex_key_b_sector-" + id[1]).val() : key;
        for (var block = start; block < (start + 3); block++) {
            if (block != 0) {
                var data = $("#block_data-" + id[1] + "_" + block).val();
                data == "Vazio" ? data = "" : data;
                await saveSectorData(id[1], block, type, key, data);
            }
        }
    }

    async function asyncTagSave() {
        logTableAdd("reset");
        for (var sector = 0; sector < 16; sector++) {
            var start = (sector * 4);
            var type = $("#nfc_type_key_sector-" + sector).val();
            var key = $("#nfc_hex_key_a_sector-" + sector).val();
            type == 1 ? key = $("#nfc_hex_key_b_sector-" + sector).val() : key;
            for (var block = start; block < (start + 3); block++) {
                if (block != 0) {
                    var data = $("#block_data-" + sector + "_" + block).val();
                    data == "Vazio" ? data = "" : data;
                    await saveSectorData(sector, block, type, key, data);
                }
            }
        }
    }

    $("#nfc_tag_save").click(function() {
        asyncTagSave().then(() => {
            notify("success", "Comando concluído, consulte o log de gravação para obter mais detalhes.");
            ONOFF("off");
        }).catch((error) => {
            notify("error", "Ocorreu um erro durante o processamento: " + error);
        });
    });

    function saveSectorData(sector, block, type, key, data) {
        return new Promise((resolve, reject) => {
            if (data.length <= 16) {
                if (key != "") {
                    var requestData = {
                        "block": block,
                        "type": type,
                        "key": key,
                        "data": StringToHex(data)
                    };
                    request("/NFC_WRITE_ON", requestData, function (response) {
                        if (isJson(response)) {
                            var json = JSON.parse(response);
                            json.status == "error" ? json.message = "Erro na Gravação!" : json.message = "Dados Gravados com Sucesso!";
                            logTableAdd(json.status, "Setor: " + sector + " Bloco: " + block, json.message);
                            resolve(); // Resolvendo a promessa quando a operação é concluída com sucesso
                        }
                    }, function (response) {
                        logTableAdd("error", "Setor: " + sector + " Bloco: " + block, "Houve um problema com a comunicação.");
                        reject(new Error("Houve um problema com a comunicação.")); // Rejeitando a promessa se houver um problema de comunicação
                    });
                } else {
                    logTableAdd("warning", "Setor: " + sector + " Bloco: " + block, "A chave de acesso do setor não foi informada.");
                    reject(new Error("A chave de acesso do setor não foi informada.")); // Rejeitando a promessa se a chave não for informada
                }
            } else {
                logTableAdd("warning", "Setor: " + sector + " Bloco: " + block, "O dado a ser gravado não pode exceder 16 caracteres.");
                reject(new Error("O dado a ser gravado não pode exceder 16 caracteres.")); // Rejeitando a promessa se o dado exceder 16 caracteres
            }
        });
    }

    function logTableAdd(status, title, menssage) {
        if(status == "reset") {
            $("#nfc_table_log tbody").html("");
        } else if(status == "error") {
            $("#nfc_table_log tbody").append('<tr class="table-danger"><td width="10%"><span class="d-flex align-items-center"><i class="bi bi-circle-fill fs-6px text-danger me-2"></i>' + title + '</span></td><td width="10%"><small>' + menssage + '</small></td><td width="80%" class="text-end"><small>' + getDateTime() + '</small></td></tr>');
        } else if(status == "success") {
            $("#nfc_table_log tbody").append('<tr class="table-success"><td width="10%"><span class="d-flex align-items-center"><i class="bi bi-circle-fill fs-6px text-success me-2"></i>' + title + '</span></td><td width="10%"><small>' + menssage + '</small></td><td width="80%" class="text-end"><small>' + getDateTime() + '</small></td></tr>');
        } else {
            $("#nfc_table_log tbody").append('<tr class="table-warning"><td width="10%"><span class="d-flex align-items-center"><i class="bi bi-circle-fill fs-6px text-warning me-2"></i>' + title + '</span></td><td width="10%"><small>' + menssage + '</small></td><td width="80%" class="text-end"><small>' + getDateTime() + '</small></td></tr>');
        }
    }

    function ONOFF(type, success = "", error = "") {

        $("#nfc_on_off").addClass("text-danger").removeClass("text-success");

        var url = "/SYSTEM_OFF";

        if (type == "on") {
            url = "/NFC_READ_ON";
        }

        request(url, {}, function (response) {
            if (response == "ok") {
                if (type == "on") {
                    $("#nfc_on_off").removeClass("text-danger").addClass("text-success");
                    notify("success", "Modo leitura ligado, aguardando TAG...");
                }
                if (success != "") {
                    success(response);
                }
            } else {
                notify("error", "O modo leitura não pode ser ligado.");
            }
        }, function (response) {
            notify("error", "Houve um problema com a comunicação.");
            if (error != "") {
                error(response);
            }
        });

    }

    function jsonTagRead(json_str) {
        if (isJson(json_str)) {

            notify("success", "Dados lidos, processando...");
            var json = JSON.parse(json_str);

            if (json.type == "NFC_TAG_4K") {

                tag_size = 16;
                
                var ignore = [ 0, 3, 7, 11, 15, 19, 23, 27, 31, 35, 39, 43, 47, 51, 55, 59, 63 ];

                $("#card_uid").val(json.uid);
                $("#json-nfc").val(json_str);
                json_mdfy = json_str;

                for (var i = 0; i < tag_size; i++) {

                    var key_a = json["sector_" + i]["key_a"];
                    if(key_a != "") {     
                        $("#nfc_str_key_a_sector-" + i).val(HexToString(key_a));
                        $("#nfc_hex_key_a_sector-" + i).val(key_a);
                        $("#nfc_card-" + i).removeClass("bg-danger bg-opacity-25");
                    } else {
                        $("#nfc_str_key_a_sector-" + i).val("");
                        $("#nfc_hex_key_a_sector-" + i).val("");
                        $("#nfc_card-" + i).addClass("bg-danger bg-opacity-25");
                    }
                    
                    var key_acs = json["sector_" + i]["key_acs"];
                    if(key_acs != "") {
                        $("#nfc_str_key_acs_sector-" + i).val(HexToString(key_acs));
                        $("#nfc_hex_key_acs_sector-" + i).val(key_acs);
                        $("#nfc_new_str_key_acs_sector-" + i).val(HexToString(key_acs));
                        $("#nfc_new_hex_key_acs_sector-" + i).val(key_acs);
                        $("#nfc_card-" + i).removeClass("bg-danger bg-opacity-25");
                    } else {
                        $("#nfc_str_key_acs_sector-" + i).val("");
                        $("#nfc_hex_key_acs_sector-" + i).val("");
                        $("#nfc_card-" + i).addClass("bg-danger bg-opacity-25");
                    }
                    
                    var key_b = json["sector_" + i]["key_b"];
                    if(key_b != "") {
                        $("#nfc_str_key_b_sector-" + i).val(HexToString(key_b));
                        $("#nfc_hex_key_b_sector-" + i).val(key_b);
                        $("#nfc_card-" + i).removeClass("bg-danger bg-opacity-25");
                    } else {
                        $("#nfc_str_key_b_sector-" + i).val("");
                        $("#nfc_hex_key_b_sector-" + i).val("");
                        $("#nfc_card-" + i).addClass("bg-danger bg-opacity-25");
                    }

                    for (var j = 0; j < 4; j++) {
                        var block = ((i * 4) + j);
                        var data = json["sector_" + i]["block_" + block]["data"];
                        if (!ignore.includes(block)) {
                            var text = HexToString(data);
                            if(text != "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" && text != "") {
                                $("#block_data-" + i + "_" + block).val(text);
                            } else {
                                $("#block_data-" + i + "_" + block).val("Vazio");
                            }
                        }
                    }
                }

                notify("success", "Os dados foram processados com sucesso!");

                window.setTimeout(function () {
                    ONOFF("off");
                }, 250);
            }

        } else {
            notify("error", "Os dados lidos foram corrompidos, tente novamente.");
        }
    }

    function list_dir_nfc(success = "", error = "") {
        request("/NFC_LIST_DIR", {}, function (response) {
            if (isJson(response)) {
                var json = JSON.parse(response);
                $("#nfc_files_tree").html("");
                generateTreeView("nfc_files_tree", json.root, 0, "NFC/", (response) => {
                    jsonTagRead(response);
                });
                if (success != "") {
                    success();
                }
            } else {
                notify("error", "O modo leitura não pode ser ligado.");
                if (error != "") {
                    error();
                }
            }
        }, function (response) {
            notify("error", "Houve um problema com a comunicação.");
        });
    }

    $(document).ready(function () {

        $("#json-nfc").val(json_empy);

        ws.onmessage = function (event) {
            jsonTagRead(event.data);
        };

        EmpyTableCardData();
        // EmpyKeyBySector();

        $("#nfc_menu_info").click(function () {
            AnimateMenu($(this), "block-legend");
        });

        $("#nfc_menu_sd_card").click(function () {
            AnimateMenu($(this), "block-sd-card");
        });

        $("#nfc_menu_tag").click(function () {
            AnimateMenu($(this), "block-tag");
        });

        $("#nfc_menu_log").click(function () {
            AnimateMenu($(this), "block-log");
        });

        $("#nfc_menu_read").click(function () {
            if($("#nfc_on_off").hasClass("text-success")) {
                ONOFF("off");
            } else {
                ONOFF("on");
            }
        });

        $("#path-nfc-input").keyup(function () {
            var text = $(this).val();
            text = text.replaceAll(/\.|\/|\\/g, "");
            $(this).val(text);
        });

        $("#list-files-sd").click(function () {
            list_dir_nfc();
        });

        $("#create-file").click(function () {
            var path = $("#path-nfc").html() + "/" + $("#path-nfc-input").val();
            request("/CREATE_FILE", { path: path }, function (response) {
                if (response == "ok") {
                    notify("success", "Arquivo criado com sucesso.");
                    list_dir_nfc(function () {
                        var path = $("#path-nfc").html().split("/");
                        var dir = "";
                        for (var j = 1; j < path.length; j++) {
                            dir += "_" + remove_accents(path[j].replaceAll(/\ |\\/g, "_").toLowerCase());
                            $("#nfc" + dir).collapse("toggle");
                        }
                    });
                } else {
                    notify("error", "O arquivo não pode ser criado.");
                }
            }, function (response) {
                notify("error", "Houve um problema com a comunicação.");
            });
        });

        $("#create-folder").click(function () {
            var path = $("#path-nfc").html() + "/" + $("#path-nfc-input").val();
            request("/CREATE_FOLDER", { path: path }, function (response) {
                if (response == "ok") {
                    notify("success", "Pasta criada com sucesso.");
                    list_dir_nfc(function () {
                        var path = $("#path-nfc").html().split("/");
                        var dir = "";
                        for (var j = 1; j < path.length; j++) {
                            dir += "_" + remove_accents(path[j].replaceAll(/\ |\\/g, "_").toLowerCase());
                            $("#nfc" + dir).collapse("toggle");
                        }
                    });
                } else {
                    notify("error", "A pasta não pode ser criada.");
                }
            }, function (response) {
                notify("error", "Houve um problema com a comunicação.");
            });
        });

    });

</script>