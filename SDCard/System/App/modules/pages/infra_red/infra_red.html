<div class="card card-fixed">
    <div class="card-body">
        <div class="btn-toolbar" role="toolbar">
            <div class="d-flex align-items-center me-2 ms-1">
                <div class="form-check form-switch pop" data-bs-content="Ligar/Desligar leitura Infra Vermelho">
                    <input type="checkbox" class="form-check-input" id="ir_menu_read" style="width: 4.5em; height: 2.8em;">
                    <!-- <label class="form-check-label" for="nfc_menu_read"></label> -->
                </div>
            </div>
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-secondary pop me-2 rounded-2" data-bs-content="Menú Tags SDCard" onclick="menuOpen(this, 'block-sd-card-ir')">
                    <i class="bi bi-sd-card"></i>
                </button>
            </div>
            <!-- <div class="input-group flex-nowrap w-100">
                <span class="input-group-text">TAG UID</span>
                <input type="text" id="card_uid" class="form-control form-control text-uppercase" style="min-width: 150px;" placeholder="00000000" readonly>
            </div> -->
        </div>
    </div>
</div>

<div class="mt-5"></div>

<div id="block-sd-card-ir" class="animated-05 fadeInLeft d-none row m-0">
    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-header fw-bold small text-uppercase p-0 ps-2 pe-2">
                Infra Vermelho SDCard
                <div class="d-flex flex-row">
                    <a id="list-files-sd-ir" class="float-end fs-6 bi-list-task p-2 m-1 text-inverse rounded-circle pop" data-bs-content="Listar" role="button"></a>
                </div>
            </div>
            <div class="card-body">
                <div id="ir_files_tree" class="treeview p-2">
                    <small>Para ver a lista de arquivos contidos no SDCard clique em " <span class="bi-list-task"></span> " Listar no menú.</small>
                </div>
                <br>
                <label class="form-label" for="json-ir">IR JSON</label>
                <textarea class="form-control" id="json-ir" rows="8" placeholder="Nenhuma Tag Lida ou Carregada." readonly></textarea>
            </div>
            <div class="card-arrow">
                <div class="card-arrow-top-left"></div>
                <div class="card-arrow-top-right"></div>
                <div class="card-arrow-bottom-left"></div>
                <div class="card-arrow-bottom-right"></div>
            </div>
        </div>
    </div>
</div>

<div id="block-ir" class="animated-05 fadeInLeft row m-0">
    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-header fw-bold small text-uppercase">
                Infra Vermelho
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 col-lg-4">

                        <div id="block-ir" class="animated-05 fadeInLeft row m-0">
                            <div class="col-12 mb-3">
                                <div class="card">
                                    <div class="card-header fw-bold small text-uppercase">
                                        Informações do Sinal
                                    </div>
                                    <div class="card-body">
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Endereço</span>
                                            <input type="text" class="form-control" id="ir-address" readonly></input>
                                        </div>
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Comando</span>
                                            <input type="text" class="form-control" id="ir-command" readonly></input>
                                        </div>
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Decoder</span>
                                            <input type="text" class="form-control" id="ir-decode" readonly></input>
                                        </div>
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Bits</span>
                                            <input type="text" class="form-control" id="ir-bits" readonly></input>
                                        </div>
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Value</span>
                                            <input type="text" class="form-control" id="ir-value" readonly></input>
                                        </div>
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Tamanho Raw</span>
                                            <input type="text" class="form-control" id="ir-length" readonly></input>
                                        </div>
                                        <div class="input-group flex-nowrap w-100 mb-2">
                                            <span class="input-group-text">Repetir</span>
                                            <input type="number" class="form-control" id="ir-repeat" value="10"></input>
                                            <span class="input-group-text">Vezes</span>
                                        </div>
                                        <buttom id="ir_emulate" class="btn btn-default form-control mt-2">Emular dados lidos.</buttom>
                                    </div>
                                    <div class="card-arrow">
                                        <div class="card-arrow-top-left"></div>
                                        <div class="card-arrow-top-right"></div>
                                        <div class="card-arrow-bottom-left"></div>
                                        <div class="card-arrow-bottom-right"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-12 col-lg-8">

                        <div id="block-ir" class="animated-05 fadeInLeft row m-0">
                            <div class="col-12 mb-3">
                                <div class="card">
                                    <div class="card-header fw-bold small text-uppercase">
                                        Sinal
                                    </div>
                                    <div class="card-body">
                                        <label class="form-label" for="ir-raw-data">Raw Sinal Data</label>
                                        <textarea class="form-control" id="ir-raw-data" rows="14" placeholder="Nenhuma sinal lido." readonly></textarea>
                                    </div>
                                    <div class="card-arrow">
                                        <div class="card-arrow-top-left"></div>
                                        <div class="card-arrow-top-right"></div>
                                        <div class="card-arrow-bottom-left"></div>
                                        <div class="card-arrow-bottom-right"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="card-arrow">
                <div class="card-arrow-top-left"></div>
                <div class="card-arrow-top-right"></div>
                <div class="card-arrow-bottom-left"></div>
                <div class="card-arrow-bottom-right"></div>
            </div>
        </div>
    </div>
</div>

<!-- <div id="ir-data" class="row m-0">

</div> -->

<script>

    function ONOFF(type, success = "", error = "") {

        $("#ir_menu_read").addClass("text-danger").removeClass("text-success");

        var url = "/SYSTEM_OFF";

        if (type == "on") {
            url = "/IR_READ_ON";
        }

        request(url, "POST", {}, function (response) {
            if (response == "ok") {
                if (type == "on") {
                    $("#ir_menu_read").removeClass("text-danger").addClass("text-success");
                    notify("success", "Modo leitura ligado, aguardando Sinal...");
                }
                if (success != "") {
                    success(response);
                }
            } else {
                notify("error", "O modo leitura não pode ser ligado.");
                $("#ir_menu_read").prop('checked', $(this).is(':checked'));
            }
        }, function (response) {
            notify("error", "Houve um problema com a comunicação.");
            $("#ir_menu_read").prop('checked', $(this).is(':checked'));
            if (error != "") {
                error(response);
            }
        });

    }

    function jsonIrRead(json_str) {
        if (isJson(json_str)) {

            $("#ir_menu_read").prop('checked', $(this).is(':checked'));
            var json = JSON.parse(json_str);

            if (json.signal) {

                $("#json-ir").val(json_str);
                $("#ir-raw-data").val(json.signal);
                $("#ir-address").val(json.address);
                $("#ir-command").val(json.command);
                $("#ir-decode").val(json.decode);
                $("#ir-bits").val(json.bits);
                $("#ir-value").val(json.value);
                $("#ir-length").val(json.length);

                notify("success", "Os dados foram processados com sucesso!");
                ONOFF("off");
            }

        } else {
            notify("error", "Os dados lidos foram corrompidos, tente novamente.");
        }
    }

    $(document).ready(function () {
        
        ws.onmessage = function (event) {
            jsonIrRead(event.data);
        };

        $("#ir_menu_read").click(function() {
            if($("#ir_menu_read").is(":checked")) {
                ONOFF("on");
            } else {
                ONOFF("off");
            }
        });

        $("#list-files-sd-ir").click(function () {
            listDirSDCard("ir_files_tree", "json-ir", "INFRARED", (data) => {
                jsonIrRead(data);
            });
        });

        $("#ir_emulate").click(function() {
            request("/IR_EMULATE", "POST", {
                rawData: $("#ir-raw-data").val(), 
                size: $("#ir-length").val(),
                times: $("#ir-repeat").val()
            }, function (response) {
                if(response == "ok") {
                    notify("success", "Sinal Emulado com sucesso.");
                }
                // if (isJson(response)) {
                //     var json = JSON.parse(response);
                //     notify(json.status, json.menssage);
                // }
            }, function (response) {
                notify("error", "Houve um problema com a comunicação.");
            });
        });

    });

</script>